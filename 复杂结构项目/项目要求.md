# 物品信息管理系统

## 一、项目概述

### 1.1 项目背景

开发一个完整的物品信息管理系统后端，支持多角色操作，包含完整的数据库设计、业务逻辑和 API 接口。

### 1.2 核心功能

- **普通用户**：物品借出、归还、查询
- **管理员**：用户账号创建、删除、管理
- **系统功能**：逾期预警、统计查询

## 二、详细需求说明

### 2.1 角色与权限

```text
普通用户：
- 查看可借物品列表
- 借出物品（需记录借出时间、预计归还时间）
- 归还物品（更新状态和实际归还时间）
- 查询个人借阅记录

管理员：
- 创建新用户账号
- 删除用户账号（需处理关联数据）
- 修改用户信息
- 查看所有用户的借阅记录
- 管理物品信息（增删改查）
```

### 2.2 功能模块详细要求

#### 物品管理模块

```text
1. 物品属性：
   - 物品ID（主键）
   - 名称
   - 描述
   - 类别（如：图书、设备、工具等）
   - 状态（可借、已借出、维护中）
   - 创建时间
   - 最后更新时间

2. 功能要求：
   - 分页查询物品列表
   - 按类别/状态/名称搜索
   - 物品状态自动更新
```

#### 借阅管理模块

```text
1. 借阅记录属性：
   - 借阅ID
   - 用户ID
   - 物品ID
   - 借出时间
   - 预计归还时间
   - 实际归还时间
   - 借阅状态（进行中、已归还、逾期）
   - 逾期天数（计算字段）

2. 业务规则：
   - 借出时自动计算预计归还时间（默认7天）
   - 归还时校验物品和用户信息
   - 自动更新物品状态
   - 逾期状态自动计算
```

#### 用户管理模块

```text
1. 用户类型：
   - 普通用户（默认）
   - 管理员

2. 用户属性：
   - 用户ID
   - 用户名（唯一）
   - 密码（需加密存储）
   - 邮箱
   - 手机号
   - 用户类型
   - 注册时间
   - 最后登录时间
   - 账号状态（正常、禁用）
```

#### 系统预警模块

```text
1. 预警规则：
   - 查询即将到期（3天内）的借阅记录
   - 查询已逾期的借阅记录
   - 统计用户逾期次数

2. 查询方式：
   - 按用户查询
   - 查询所有用户的预警信息
   - 支持分页和筛选
```

### 2.3 API 接口规范

#### 认证相关

```text
POST /api/auth/login
请求体：{username, password}
响应：{token, userInfo}

POST /api/auth/logout
请求头：Authorization: Bearer {token}
```

#### 物品管理

```text
GET /api/items?page=1&size=10&category=图书&status=可借
GET /api/items/{id}
POST /api/items (管理员)
PUT /api/items/{id} (管理员)
DELETE /api/items/{id} (管理员)
```

#### 借阅管理

```text
POST /api/borrow
请求体：{userId, itemId, expectedReturnDate}

POST /api/return/{borrowId}
请求体：{actualReturnDate}

GET /api/users/{userId}/borrow-records
```

#### 用户管理（管理员）

```text
POST /api/admin/users
请求体：{username, password, email, phone, userType}

PUT /api/admin/users/{userId}
DELETE /api/admin/users/{userId}
GET /api/admin/users?page=1&size=10
```

#### 预警查询

```text
GET /api/alerts/upcoming-returns?days=3
GET /api/alerts/overdue
GET /api/alerts/user/{userId}/overdue
```

### 2.4 数据库设计（MySQL）

#### 表结构

```sql
-- 用户表
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    user_type ENUM('USER', 'ADMIN') DEFAULT 'USER',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_status (status)
);

-- 物品表
CREATE TABLE items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    status ENUM('AVAILABLE', 'BORROWED', 'MAINTENANCE') DEFAULT 'AVAILABLE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_status (status)
);

-- 借阅记录表
CREATE TABLE borrow_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    item_id BIGINT NOT NULL,
    borrow_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expected_return_date DATE NOT NULL,
    actual_return_date DATE,
    status ENUM('ACTIVE', 'RETURNED', 'OVERDUE') DEFAULT 'ACTIVE',
    overdue_days INT DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    INDEX idx_user_item (user_id, item_id),
    INDEX idx_expected_date (expected_return_date),
    INDEX idx_status (status)
);
```

#### 视图（可选）

```sql
-- 逾期预警视图
CREATE VIEW overdue_alerts AS
SELECT
    br.id,
    u.username,
    i.name as item_name,
    br.borrow_date,
    br.expected_return_date,
    DATEDIFF(CURDATE(), br.expected_return_date) as overdue_days
FROM borrow_records br
JOIN users u ON br.user_id = u.id
JOIN items i ON br.item_id = i.id
WHERE br.status = 'ACTIVE'
AND br.expected_return_date < CURDATE();
```

### 2.5 技术栈要求

#### 必需技术

```text
- Java 21
- Spring Boot 2.7+
- Spring Data JPA
- Spring Security + JWT
- MySQL 8.3
- Maven/Gradle 构建工具
```

#### 建议架构

```text
- 分层架构：Controller → Service → Repository
- 统一异常处理
- 统一响应格式
- 输入参数验证
- 数据库事务管理
```

### 2.6 配置文件示例

```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:3306/item_management
    username: ${DB_USER:root}
    password: ${DB_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true

app:
  jwt:
    secret: ${JWT_SECRET:your-secret-key}
    expiration: 86400000 # 24小时
  borrow:
    default-days: 7
    alert-days: 3
```

### 2.7 非功能性需求

#### 代码质量

```text
1. 代码规范：
   - 遵循Java编码规范
   - 使用有意义的命名
   - 适当添加注释

2. 错误处理：
   - 统一的错误码和错误信息
   - 异常日志记录
   - 友好的错误提示

3. 安全性：
   - SQL注入防护
   - XSS防护
   - 密码加密存储
   - API权限控制
```

#### 性能要求

```text
1. 数据库查询优化
2. 合理的索引设计
3. 分页查询支持
4. 避免N+1查询问题
```
